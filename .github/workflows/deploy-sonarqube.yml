name: 🐬 Build SonarQube Image

on:
    push:
        paths:
            - 'apps/sonarqube/**'
            - '.github/workflows/deploy-sonarqube.yml'
    pull_request:
        paths:
            - 'apps/sonarqube/**'

jobs:
    build-sonarqube:
        name: 🔧 Build & Validate SonarQube
        runs-on: ubuntu-latest

        defaults:
            run:
                working-directory: apps/sonarqube
            
        steps:
            - name: ⬇️ Checkout code
              uses: actions/checkout@v4

            - name: 🔐 Setup SSH key
              run: |
                mkdir -p ~/.ssh
                echo "${{ secrets.SONAR_SSH_KEY }}" > ~/.ssh/id_rsa
                chmod 600 ~/.ssh/id_rsa
                ssh-keyscan -p ${{ secrets.SONAR_SSH_PORT }} -H ${{ secrets.SONAR_SSH_HOST }} >> ~/.ssh/known_hosts

            - name: 🚀 Deploy SonarQube via SSH
              run: |
                scp -P ${{ secrets.SONAR_SSH_PORT }} apps/sonarqube/base/compose.yaml ${{ secrets.SONAR_SSH_HOST }}:/tmp/compose.yaml
                ssh -p ${{ secrets.SONAR_SSH_PORT }} ${{ secrets.SONAR_SSH_HOST }} "
                  docker compose -f /tmp/compose.yaml down || true
                  docker compose -f /tmp/compose.yaml up -d
                "

            - name: 🐳 Set Up Docker Buildx
              uses: docker/setup-buildx-action@v3

            - name: 🔍 Validate docker-compose config
              run: docker compose -f config/compose.yaml config

            - name: 🔨 Build custom SonarQube image
              run: docker compose -f config/compose.yaml build