name: 🛠️ Build & 🚀 Deploy OpenCTI
on:
    workflow_dispatch:
jobs:
    deploy:
        name: 🧪 Deploy OpenCTI
        runs-on: self-hosted

        steps:
            - name: 📥 Checkout repo
              uses: actions/checkout@v4
            - name: 🔍 Validar YAML (ignorar estilo estricto)
              run: yamllint apps/opencti/config
            - name: 🔧 Establecer vm.max_map_count
              run: |
                sudo sysctl -w vm.max_map_count=1048575
                echo "vm.max_map_count=1048575" | sudo tee -a /etc/sysctl.conf
            - name: 🧩 Crear archivo .env desde plantilla
              run: cp apps/opencti/config/.env.sample apps/opencti/config/.env
            - name: 🌱 Exportar variables .env
              run: |
                export $(grep -v '^#' apps/opencti/config/.env | xargs)
            - name: 🚀 Deplegar OpenCTI con docker-compose
              run: |
                cd apps/opencti/config
                docker compose down
                docker compose up -d
            - name: 🧪 Comprobar estado de contenedores
              run: docker ps -a
